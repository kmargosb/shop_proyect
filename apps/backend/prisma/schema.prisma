generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ============================
 * USER
 * ============================
 */

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String?
  name     String?
  role     Role    @default(USER)

  tokenVersion Int @default(0)

  loginAttempts Int       @default(0)
  lockUntil     DateTime?

  refreshTokens RefreshToken[]
  orders        Order[] // ðŸ”¥ relaciÃ³n inversa

  createdAt DateTime @default(now())
}

/**
 * ============================
 * PRODUCT
 * ============================
 */

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  price       Float
  stock       Int

  images     ProductImage[]
  orderItems OrderItem[] // ðŸ”¥ relaciÃ³n inversa

  createdAt DateTime @default(now())
}

/**
 * ============================
 * PRODUCT IMAGE
 * ============================
 */

model ProductImage {
  id       String @id @default(uuid())
  url      String
  publicId String

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
}

/**
 * ============================
 * ORDER
 * ============================
 */

model Order {
  id String @id @default(uuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  fullName String
  email    String
  phone    String

  addressLine1 String
  addressLine2 String?
  city         String
  postalCode   String
  country      String

  total  Float
  status OrderStatus @default(PENDING)

  items OrderItem[]

  createdAt DateTime @default(now())
  invoice   Invoice?
}

/**
 * ============================
 * ORDER ITEM
 * ============================
 */

model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  price    Float // ðŸ”¥ precio congelado al momento de compra
}

/**
 * ============================
 * REFRESH TOKEN
 * ============================
 */

model RefreshToken {
  id     String @id @default(uuid())
  token  String @unique
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  expiresAt DateTime
}

/**
 * ============================
 * ENUMS
 * ============================
 */

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  CANCELLED
}

/**
 * ============================
 * Facturacion
 * ============================
 */

model Invoice {
  id            String @id @default(uuid())
  invoiceNumber Int    @unique

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  customerEmail String
  total         Float

  createdAt DateTime @default(now())
}
